#!/bin/bash
set -ex

DATADIR=/var/lib/mysql

# 0) S’assurer que le dossier data appartient à mysql:mysql
chown -R mysql:mysql "$DATADIR"

# 1) Initialisation si répertoire vide
if [ -z "$(ls -A "$DATADIR/mysql" 2>/dev/null)" ]; then
  echo "[MariaDB] Initialisation du répertoire de données…"
  mysql_install_db --user=mysql --datadir="$DATADIR"
fi

# 2) Démarre un serveur temporaire
echo "[MariaDB] Démarrage temporaire de mariadbd…"
mysqld_safe --datadir="$DATADIR" &
PID_TMP=$!

# 3) Attente active
echo "[MariaDB] Attente de la mise en route…"
for i in $(seq 1 10); do
  mysqladmin ping --silent -uroot && break
  sleep 1
done

# 4) Applique la configuration (root, DB, user WP)
echo "[MariaDB] Configuration initiale…"
mysql -uroot <<-EOSQL
  ALTER USER 'root'@'localhost' IDENTIFIED BY '${MYSQL_ROOT_PASSWORD}';
  CREATE DATABASE IF NOT EXISTS \`${MYSQL_DATABASE}\`;
  CREATE USER IF NOT EXISTS '${MYSQL_USER}'@'%' IDENTIFIED BY '${MYSQL_PASSWORD}';
  GRANT ALL PRIVILEGES ON \`${MYSQL_DATABASE}\`.* TO '${MYSQL_USER}'@'%';
  FLUSH PRIVILEGES;
EOSQL

# 5) Arrêt du serveur temporaire
echo "[MariaDB] Arrêt du serveur temporaire…"
mysqladmin -uroot -p"${MYSQL_ROOT_PASSWORD}" shutdown

# 6) Démarrage final (foreground)
echo "[MariaDB] Démarrage final en avant-plan…"
exec mysqld_safe --datadir="$DATADIR"
